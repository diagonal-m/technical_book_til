# データベース設計の基礎知識

## 3つのポイント

　データベース設計における悩み事は、突き詰めていくと概ね次の3つに集約される

1. **箱(エンティティ)の見出し方**
2. **主キーの設定**
3. **重複の排除(いわゆる正規化)**



## 箱(エンティティ)の見出し方

### エンティティとは何か

- エンティティというのは何かの集合のこと
- 集まりに入っているかどうかを明確に区別するために、エンティティという箱に入れるイメージ

> 学校のクラス。それぞれのクラスには生徒がたくさんいる。別にどこにいても同じクラスの人同士であることは変わらない。しかしいつも広い校庭でバラバラになっていると見分けがつかないので、普段は教室に入る。この教室をエンティティだと考える



### エンティティ名の役割

- データの「意味」による名前づけが行われる
- 「このデータは何についての記録なのか」ということを整理して、同じ意味を持つもの同士を1つの箱に入れる



**そもそもなぜデータベースを使うのか**

- 「消えると困るデータを記録しておくため」→後からいろいろと使いたい
- 残すからには、それがどういうものなのか区別できる必要がある



### エンティティ名の決め方

- 「記録したくないもの」はデータベース設計の対象から除外しても構わない
  - 設計の対象となるシステムのスコープの範囲によって変化する
- 「何について記録したいのか」がエンティティ名の候補となる
  - 「こういうお客様がいる」「こんな商品を扱っている」→「モノ」について
  - 「販売をした」「仕入れをした」→「行為」について
- 「出来事」や「モノ」について管理をしたいので記録を残す
  - エンティティのことを「管理対象」と呼んだりすることもある
  - モノに関する記録のこと→「リソース(資源)系エンティティ」
  - 出来事についての記録のこと→「イベント系エンティティ」
- リソース系とイベント系というのを手がかりにエンティティを見出す
  - システム化の対象となる業務に関して、名詞と動詞による分類
  - 見出したエンティティ名を6W3Hによる整理を行うことでビジネスモデルとデータモデルの間の整合性を見ていくことができる

| エンティティの候補                                 | 6W3H     |
| -------------------------------------------------- | -------- |
| ・リソース系                                       |          |
| 誰に(顧客・仕入先)                                 | Whom     |
| 誰が(従業員・役職・組織など)                       | Who      |
| 何を(商品・勘定科目など)                           | What     |
| どこ(販売ルート・地域・支店や営業所)               | Where    |
| ・イベント系                                       |          |
| どのように(販売・仕入・出荷・入金など)             | How      |
| ・属性の候補                                       |          |
| いつ                                               | When     |
| どれくらい(量)                                     | How many |
| いくら(金額)                                       | How much |
| ・いわゆるビジネス上の正規化の対象となってくるもの |          |
| なぜ(売上・返品・値引き・補充など)                 | Why      |



## キーの設定

- キーの定義→データベースにおいて非常に重要
  - キー定義の良し悪しでデータベース設計のクオリティが左右される

### キーとは何か

- キー→Key→鍵→手がかり
  - データを特定する・あるデータに到達するための手がかり
  - 大量のデータの中から欲しいものをできるだけ簡単に見つけ出すための手がかりとしてキーを用意
- キーの種類
  - 主キー(プライマリキー)
  - ユニークキー
  - 候補キー
  - 外部キー(フォーリンキー)

**主キー(プライマリキー)**

- 候補キーの中から何らかの意味的に選択された、インスタンスを特定可能な識別子
- 物理的にはPRIMARY KEY「制約」
- 実態はNOT NULLのユニークインデックス

**候補キー**

- エンティティ内のインスタンスをそれぞれに特定可能な識別子の「すべて」
- 実装上はインデックス

**ユニークキー**

- エンティティ内のインスタンスをそれぞれに特定可能な識別子
- 実装上はユニークインデックス。対象のカラムにNOT NULL制約がなければNULは許可される



### コードとキーの違い

- 「顧客エンティティ」があるとする

  - たいてい顧客コード(顧客番号)が設定されている

  - この顧客コードを主キーにしてしまう→これは論理的には問題ない

    - 顧客エンティティの箱の中で1件のインスタンスを見分けて選び出すための「主たる手がかり」として顧客コードを使うのはまったくもって正解

  - 次のようなSQL→問題のきっかけ

    ```sql
    CREATE TABLE 顧客 (顧客コード VARCAHR(7) PRIMARY KEY, ...);
    ```

  - これ自体が問題なのではない

  - 顧客テーブルと関連を持つ、売上テーブルが顧客テーブルを参照する(外部キーをもつ)としたら

    ```sql
    CREATE TABLE 売上 (..., 顧客コード VARCAHR(7) REFERENCES 顧客(顧客コード), ...);
    ```

  - 売上テーブルの顧客コードは、顧客テーブルの顧客コードを参照することになる→一見問題なし

  - コード体系が変更されたらどうなる？

    - 顧客コードが完全にユニークでないケースが生じたら？

  - データ中心アプローチの世界では「全社統一コード体系の整備」を金科玉条のように掲げている

    - 次の2点の理由により普遍的ではない
      - **コード体系は、ユーザがレコードに容易に到達するためのユーザインターフェイスである**
      - **コード体系は、システムの都合ではなくビジネスの都合によって決定されるものである**

  